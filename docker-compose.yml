# Vibgyor Payment Gateway - Docker Compose Configuration
# For local development environment

version: '3.8'

services:
  # Backend Service
  backend:
    build:
      context: ./backend
      dockerfile: Dockerfile
    container_name: vibgyor-backend
    ports:
      - "3000:3000"
    environment:
      # Server Configuration
      - PORT=3000
      - NODE_ENV=development
      - LOG_LEVEL=info
      
      # Payment Provider Configuration
      # Change to 'pinelabs' to use PineLabs instead
      - PAYMENT_PROVIDER=razorpay
      
      # Razorpay Configuration (required if PAYMENT_PROVIDER=razorpay)
      - RAZORPAY_KEY_ID=${RAZORPAY_KEY_ID:-rzp_test_xxxxx}
      - RAZORPAY_KEY_SECRET=${RAZORPAY_KEY_SECRET:-xxxxx}
      
      # PineLabs Configuration (required if PAYMENT_PROVIDER=pinelabs)
      - PINELABS_MERCHANT_ID=${PINELABS_MERCHANT_ID:-xxxxx}
      - PINELABS_ACCESS_CODE=${PINELABS_ACCESS_CODE:-xxxxx}
      - PINELABS_SECRET_KEY=${PINELABS_SECRET_KEY:-xxxxx}
      
      # CORS Configuration
      - ALLOWED_ORIGINS=http://localhost:8080,http://localhost:5173
    volumes:
      # Mount source code for hot reload in development
      - ./backend/src:/app/src
      - ./backend/package.json:/app/package.json
      # Exclude node_modules from volume mount
      - /app/node_modules
    networks:
      - vibgyor-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "node", "-e", "require('http').get('http://localhost:3000/health', (r) => {process.exit(r.statusCode === 200 ? 0 : 1)})"]
      interval: 30s
      timeout: 3s
      retries: 3
      start_period: 10s

  # Frontend Service
  frontend:
    build:
      context: ./frontend
      dockerfile: Dockerfile
    container_name: vibgyor-frontend
    ports:
      - "8080:8080"
    environment:
      # API Configuration
      - VITE_API_BASE_URL=http://localhost:3000
    depends_on:
      - backend
    networks:
      - vibgyor-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:8080/health"]
      interval: 30s
      timeout: 3s
      retries: 3
      start_period: 10s

networks:
  vibgyor-network:
    driver: bridge
    name: vibgyor-network

# Volumes for persistent data (if needed in future)
volumes:
  backend-data:
    name: vibgyor-backend-data
